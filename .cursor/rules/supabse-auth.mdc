---
description:
globs:
alwaysApply: true
---
Implement authentication using Supabase Auth for secure user login and session management, with role-based access control (RBAC) enforced via user roles stored in a profiles table (e.g., columns: id (UUID referencing auth.users), role (enum: 'admin', 'staff')). On login, use Supabase's supabase.auth.signInWithPassword or signInWithOtp for email/password or magic link authentication. After successful login, fetch the user's session with supabase.auth.getSession() and retrieve their role from the profiles table using a Supabase client query (e.g., supabase.from('profiles').select('role').eq('id', session.user.id)). Store the session and role in a global state (e.g., React Context or Zustand) for client-side checks. For admins, grant full access to all pages, including dashboard, settings, reports, transactions, and inventory management. For staff, restrict access exclusively to form-filling pages (Quick Sales Form, Purchase Form, Operational Expense Form) and management of menu items/ingredients/recipes (Menu & Recipe Page, Inventory Page for updates onlyâ€”no views of KPIs, graphs, or alerts). Enforce RBAC on the frontend via conditional rendering (e.g., if role !== 'admin', redirect or hide restricted routes) and on the backend via Supabase Row Level Security (RLS) policies (e.g., for tables like daily_summaries or weekly_reports, allow SELECT only if role = 'admin'). Handle session persistence with Supabase's real-time listener (supabase.auth.onAuthStateChange) to refresh or invalidate sessions on changes, and implement logout with supabase.auth.signOut(). Use secure storage for tokens (e.g., HTTP-only cookies) and validate sessions on API calls to prevent unauthorized access.